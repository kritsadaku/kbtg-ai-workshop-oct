openapi: 3.0.4
info:
  title: LBK Points - Transfer API (Public)
  version: 1.1.0
  description: |
    โอนแต้ม, ดูสถานะ, และค้นประวัติ (public, ไม่ต้องใช้ Bearer Token)
servers:
  - url: https://api.example.com
  - url: http://localhost:3000

tags:
  - name: Users
    description: User management operations
  - name: Transfers
    description: Point transfer operations

paths:
  /:
    get:
      tags: [Users]
      summary: Hello World endpoint
      operationId: hello_world
      responses:
        '200':
          description: Hello World message
          content:
            text/plain:
              schema:
                type: string

  /users:
    get:
      tags: [Users]
      summary: List all users
      operationId: list_users
      parameters:
        - name: limit
          in: query
          description: "Number of users to return (default: 100)"
          required: false
          schema:
            type: integer
            format: int64
        - name: offset
          in: query
          description: "Number of users to skip (default: 0)"
          required: false
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListUsersResponse'

    post:
      tags: [Users]
      summary: Create a new user
      operationId: create_user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /users/{id}:
    get:
      tags: [Users]
      summary: Get user by ID
      operationId: get_user
      parameters:
        - name: id
          in: path
          description: User ID
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
      responses:
        '200':
          description: User found successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Users]
      summary: Update an existing user
      operationId: update_user
      parameters:
        - name: id
          in: path
          description: User ID
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Users]
      summary: Delete a user
      operationId: delete_user
      parameters:
        - name: id
          in: path
          description: User ID
          required: true
          schema:
            type: integer
            format: int32
            minimum: 1
      responses:
        '204':
          description: User deleted successfully
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transfers:
    post:
      tags: [Transfers]
      summary: สร้างคำสั่งโอนแต้ม (ระบบจะสร้าง Idempotency-Key ให้)
      description: |
        สร้างรายการโอนแต้มแบบอะตอมมิก ระบบจะ generate `idemKey` (Idempotency-Key)
        และคืนค่าไว้ใช้ติดตามสถานะผ่าน GET /transfers/{id}
      operationId: create_transfer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTransferRequest'
            examples:
              sample:
                value:
                  fromUserId: 1
                  toUserId: 2
                  amount: 250
                  note: "ขอบคุณสำหรับช่วยงาน"
      responses:
        '201':
          description: สร้างสำเร็จ
          headers:
            Idempotency-Key:
              description: idemKey ที่ระบบสร้างให้ (ใช้เป็น /transfers/{id})
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferCreateResponse'
              examples:
                success:
                  value:
                    transfer:
                      idemKey: "5d1f8c7a-2b5b-4b1f-9f2a-8f50b0a8d9f3"
                      transferId: 1
                      fromUserId: 1
                      toUserId: 2
                      amount: 250
                      status: "completed"
                      note: "ขอบคุณสำหรับช่วยงาน"
                      createdAt: "2025-10-17T14:03:12Z"
                      updatedAt: "2025-10-17T14:03:12Z"
                      completedAt: "2025-10-17T14:03:12Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/Unprocessable'

    get:
      tags: [Transfers]
      summary: ค้น/ดูประวัติการโอน (กรองด้วย userId เท่านั้น)
      description: แสดงรายการที่ userId เกี่ยวข้อง (ทั้ง sender และ receiver) พร้อมแบ่งหน้า
      operationId: list_transfers
      parameters:
        - name: userId
          in: query
          description: แสดงเฉพาะรายการที่เกี่ยวข้องกับ userId (ทั้งโอนออกและรับเข้า)
          required: true
          schema:
            type: integer
            minimum: 1
        - name: page
          in: query
          description: หน้าที่ต้องการ (เริ่มที่ 1)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: pageSize
          in: query
          description: จำนวนต่อหน้า (1–200)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: รายการที่พบ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferListResponse'
              examples:
                page1:
                  value:
                    data:
                      - idemKey: "5d1f8c7a-2b5b-4b1f-9f2a-8f50b0a8d9f3"
                        transferId: 1
                        fromUserId: 1
                        toUserId: 2
                        amount: 250
                        status: "completed"
                        createdAt: "2025-10-17T14:03:12Z"
                        updatedAt: "2025-10-17T14:03:12Z"
                        completedAt: "2025-10-17T14:03:12Z"
                      - idemKey: "a8b4f2e0-5562-4f1c-9b62-2a2f2f4c9b10"
                        transferId: 2
                        fromUserId: 3
                        toUserId: 1
                        amount: 100
                        status: "completed"
                        createdAt: "2025-10-16T10:00:00Z"
                        updatedAt: "2025-10-16T10:00:00Z"
                        completedAt: "2025-10-16T10:00:00Z"
                    page: 1
                    pageSize: 20
                    total: 2
        '400':
          $ref: '#/components/responses/BadRequest'

  /transfers/{id}:
    get:
      tags: [Transfers]
      summary: ดูสถานะคำสั่งโอน (ใช้ idemKey เป็น id)
      operationId: get_transfer
      parameters:
        - name: id
          in: path
          required: true
          description: >
            Transfer ID สำหรับค้นหาสถานะ (เท่ากับ Idempotency-Key ที่ระบบสร้างให้ตอน POST /transfers)
          schema:
            type: string
            minLength: 8
            maxLength: 128
      responses:
        '200':
          description: ข้อมูลรายการโอน
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferGetResponse'
              examples:
                found:
                  value:
                    transfer:
                      idemKey: "5d1f8c7a-2b5b-4b1f-9f2a-8f50b0a8d9f3"
                      transferId: 1
                      fromUserId: 1
                      toUserId: 2
                      amount: 250
                      status: "completed"
                      note: "ขอบคุณสำหรับช่วยงาน"
                      createdAt: "2025-10-17T14:03:12Z"
                      updatedAt: "2025-10-17T14:03:12Z"
                      completedAt: "2025-10-17T14:03:12Z"
        '404':
          $ref: '#/components/responses/NotFound'

components:
  responses:
    BadRequest:
      description: คำขอไม่ถูกต้อง
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: ไม่พบข้อมูล
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: ความขัดแย้ง (เช่น แต้มไม่พอ)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unprocessable:
      description: ตรวจรูปแบบผ่าน แต่ทำงานต่อไม่ได้ (เช่น โอนให้ตัวเอง)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    User:
      type: object
      required:
        - id
        - first_name
        - last_name
        - phone
        - email
        - member_since
        - membership_level
        - points
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: int32
          minimum: 1
        first_name:
          type: string
        last_name:
          type: string
        phone:
          type: string
        email:
          type: string
          format: email
        member_since:
          type: string
          format: date-time
        membership_level:
          type: string
          enum: [Bronze, Silver, Gold, Platinum]
        points:
          type: integer
          format: int64
          minimum: 0
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateUserRequest:
      type: object
      required:
        - first_name
        - last_name
        - phone
        - email
      properties:
        first_name:
          type: string
          minLength: 1
          maxLength: 100
        last_name:
          type: string
          minLength: 1
          maxLength: 100
        phone:
          type: string
          pattern: '^\+66[0-9]{9}$'
        email:
          type: string
          format: email
        membership_level:
          type: string
          enum: [Bronze, Silver, Gold, Platinum]
          default: Bronze

    UpdateUserRequest:
      type: object
      properties:
        first_name:
          type: string
          nullable: true
          minLength: 1
          maxLength: 100
        last_name:
          type: string
          nullable: true
          minLength: 1
          maxLength: 100
        phone:
          type: string
          nullable: true
          pattern: '^\+66[0-9]{9}$'
        email:
          type: string
          nullable: true
          format: email
        membership_level:
          type: string
          nullable: true
          enum: [Bronze, Silver, Gold, Platinum]

    ListUsersResponse:
      type: object
      required:
        - users
        - total
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/User'
        total:
          type: integer
          minimum: 0

    TransferStatus:
      type: string
      enum: [pending, processing, completed, failed, cancelled, reversed]

    Transfer:
      type: object
      required:
        - idemKey
        - fromUserId
        - toUserId
        - amount
        - status
        - createdAt
        - updatedAt
      properties:
        idemKey:
          type: string
          description: Idempotency-Key ที่เป็น ID อ้างอิงหลักของรายการโอน
        transferId:
          type: integer
          nullable: true
          description: เลขไอดีภายในระบบ (autoincrement) — ออปชัน
        fromUserId:
          type: integer
          minimum: 1
        toUserId:
          type: integer
          minimum: 1
        amount:
          type: integer
          minimum: 1
        status:
          $ref: '#/components/schemas/TransferStatus'
        note:
          type: string
          nullable: true
          maxLength: 512
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        failReason:
          type: string
          nullable: true

    CreateTransferRequest:
      type: object
      required: [fromUserId, toUserId, amount]
      properties:
        fromUserId:
          type: integer
          minimum: 1
        toUserId:
          type: integer
          minimum: 1
        amount:
          type: integer
          minimum: 1
        note:
          type: string
          nullable: true
          maxLength: 512

    TransferCreateResponse:
      type: object
      required:
        - transfer
      properties:
        transfer:
          $ref: '#/components/schemas/Transfer'

    TransferGetResponse:
      type: object
      required:
        - transfer
      properties:
        transfer:
          $ref: '#/components/schemas/Transfer'

    TransferListResponse:
      type: object
      required:
        - data
        - page
        - pageSize
        - total
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Transfer'
        page:
          type: integer
          minimum: 1
        pageSize:
          type: integer
          minimum: 1
        total:
          type: integer
          minimum: 0

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string
          example: "amount must be > 0"